% !! USE LuaLaTeX FOR COMPILING WITH CURRENT PREAMBLE !!

% LTeX: enabled=false

% Cleaner text spacing
\usepackage[final]{microtype}
% Math-Stuff
\usepackage{mathtools}
\usepackage{keytheorems}
\usepackage{nicematrix}
% Nice code
\usepackage[chapter,newfloat]{minted}
% Plots
\usepackage{pgfplots}
% Block comments
\usepackage{verbatim}
% Subfigures
\usepackage[font=footnotesize]{subcaption}
% Font
\usepackage{fontspec}
\usepackage[warnings-off={mathtools-colon,mathtools-overbracket}]{unicode-math}
\setmainfont{XCharter}
\setmathfont{XCharter Math}
\setmathfont[range=\mathcal]{STIX Two Math}
% German
\usepackage[ngerman]{babel}
% Spacing
\linespread{1.04}
\usepackage{setspace}
% New type area calculation with font and linespread
\KOMAoptions{DIV=last}
% Header
\usepackage{scrlayer-scrpage}
% Colors and graphics
\usepackage[dvipsnames]{xcolor}
\usepackage{graphicx}
\usepackage{wrapfig}
% Nice tables
\usepackage{longtable, booktabs}
% Lists
\usepackage{enumitem}

% Bibliography
\usepackage[backend=biber,style=alphabetic,doi=false,isbn=false,eprint=false,giveninits=true,maxnames=10]{biblatex}
\addbibresource{literature.bib}
% Only for german
\DeclareFieldFormat{urldate}{(Stand: #1)}
% Author format
\renewcommand*{\multinamedelim}{\addcomma\space} 
\renewcommand*{\finalnamedelim}{\addspace\&\space}
\DeclareNameAlias{author}{family-given}
% Better linebreak for long url
\setcounter{biburllcpenalty}{9000}
\setcounter{biburlucpenalty}{9000}

% Quotes
\usepackage[autostyle=true]{csquotes}
% Nice numbers and units
\usepackage{siunitx}
% References
\usepackage[hidelinks,linktocpage=true]{hyperref}
\hypersetup{
  linkcolor  = RoyalBlue,
  citecolor  = Green,
  urlcolor   = RoyalBlue,
  colorlinks = true,
}
\usepackage[all]{hypcap}
\usepackage{zref-clever}
\usepackage{bookmark}

% Macros
\DeclareSIUnit\dollar{\$}
\newcommand{\Img}{\operatorname{Im}}
\newcommand{\df}{\operatorname{df}}
\newcommand{\diag}{\operatorname{diag}}
\newcommand{\rg}{\operatorname{rg}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\N}{\mathbb{N}}
\newcommand{\C}{\mathbb{C}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\prim}{\mathbb{P}}
\newcommand{\pot}{\mathcal{P}}
\newcommand{\Llr}{\Longleftrightarrow}
\newcommand{\Lr}{\Longrightarrow}
\newcommand{\Ll}{\Longleftarrow}
\newcommand{\Lra}{\Leftrightarrow}
\newcommand{\Ra}{\Rightarrow}
\newcommand{\La}{\Leftarrow}
\renewcommand{\vec}[1]{\symbfit{#1}}
\newcommand{\mat}[1]{\symbfit{#1}}
\DeclarePairedDelimiter\abs{\lvert}{\rvert}
\DeclarePairedDelimiter\norm{\lVert}{\rVert}

% Horizontal lines in matrix
\newcommand{\brows}[1]{%
  \begin{bmatrix}
  \begin{array}{@{\protect\rotvert\;}c@{\;\protect\rotvert}}
  #1
  \end{array}
  \end{bmatrix}
}
\newcommand{\rotvert}{\rotatebox[origin=c]{90}{\(\vert\)}}
\newcommand{\rowsvdots}{\multicolumn{1}{@{}c@{}}{\vdots}}

% Overset with flexible vertical space
\makeatletter
\newcommand{\oset}[3][0ex]{%
  \mathrel{\mathop{#3}\limits^{
    \vbox to#1{\kern-2\ex@
    \hbox{\(\scriptstyle#2\)}\vss}}}}
\makeatother

% Definition
\definecolor{defcolor}{RGB}{123, 185, 229}
\newkeytheoremstyle{defstyle}
{
  headfont=\normalfont\scshape\bfseries,
  notefont=\normalfont\bfseries,
  notebraces={(}{)},  % chktex 9
  headpunct={.},
  bodyfont=\normalfont,
  headformat=\NAME~\NUMBER\NOTE,
  break,
  tcolorbox-no-titlebar={
    enhanced,
    breakable,
    sharp corners,
    colback=defcolor!20,
    boxrule=0pt,
    leftrule=4pt,       
    colframe=defcolor,
    left=8pt,
    right=8pt,
  }
}
\newkeytheorem{definition}[
style=defstyle,
numberwithin=chapter,
name=Definition,
]

% Theorem
\definecolor{theocolor}{RGB}{237, 138, 130}
\newkeytheoremstyle{theoremstyle}
{
  headfont=\normalfont\scshape\bfseries,
  notefont=\normalfont\bfseries,
  notebraces={(}{)},  % chktex 9
  headpunct={.},
  bodyfont=\normalfont,
  headformat=\NAME~\NUMBER\NOTE,
  break,
  tcolorbox-no-titlebar={
    enhanced,
    breakable,
    sharp corners,
    colback=theocolor!20,
    boxrule=0pt,
    leftrule=4pt,       
    colframe=theocolor,
    left=8pt,
    right=8pt,
  }
}
\newkeytheorem{theorem}[
Refname={Satz,SÃ¤tze},
style=theoremstyle,
sibling=definition,
name=Satz,
]

% Corollary
\definecolor{corcolor}{RGB}{164, 214, 165}
\newkeytheoremstyle{corstyle}
{
  headfont=\normalfont\scshape\bfseries,
  notefont=\normalfont\bfseries,
  notebraces={(}{)},  % chktex 9
  headpunct={.},
  bodyfont=\normalfont,
  headformat=\NAME~\NUMBER\NOTE,
  break,
  tcolorbox-no-titlebar={
    enhanced,
    breakable,
    sharp corners,
    colback=corcolor!20,
    boxrule=0pt,
    leftrule=4pt,       
    colframe=corcolor,
    left=8pt,
    right=8pt,
  }
}
\newkeytheorem{corollary}[
Refname={Korollar,Korollare},
style=corstyle,
sibling=definition,
name=Korollar,
]

% Lemma
\definecolor{lemmacolor}{RGB}{242, 213, 133}
\newkeytheoremstyle{lemmastyle}
{
  headfont=\normalfont\scshape\bfseries,
  notefont=\normalfont\bfseries,
  notebraces={(}{)},  % chktex 9
  headpunct={.},
  bodyfont=\normalfont,
  break,
  headformat=\NAME~\NUMBER\NOTE,
  tcolorbox-no-titlebar={
    enhanced,
    breakable,
    sharp corners,
    colback=lemmacolor!20,
    boxrule=0pt,
    leftrule=4pt,       
    colframe=lemmacolor,
    left=8pt,
    right=8pt,
  }
}
\newkeytheorem{lemma}[
Refname={Lemma,Lemmata},
style=lemmastyle,
sibling=definition,
name=Lemma,
]

% Proof
\newkeytheoremstyle{proofstyle}
{
headfont=\normalfont\itshape,
notebraces={}{},
headpunct={.},
bodyfont=\normalfont,
headformat=\NAME\NOTE,
spaceabove = 0pt,
qed
}
\renewkeytheorem{proof}[
Refname={Beweis,Beweise},
style=proofstyle,
name=Beweis
]

% Derivation
\newkeytheoremstyle{deristyle}
{
headfont=\normalfont\itshape,
notebraces={}{},
headpunct={.},
bodyfont=\normalfont,
headformat=\NAME\NOTE,
spaceabove = 0pt,
qed = \(\diamond\),
}
\newkeytheorem{derivation}[
Refname={Herleitung,Herleitungen},
style=deristyle,
name=Herleitung
]

% Repitition
\definecolor{excolor}{RGB}{200, 205, 207}
\newkeytheoremstyle{repstyle}
{
headfont=\normalfont\scshape\bfseries,
notefont=\normalfont\bfseries,
notebraces={(}{)},  % chktex 9
headpunct={.},
bodyfont=\normalfont,
headformat=\NAME~\NUMBER\NOTE,
break,
tcolorbox-no-titlebar={
    enhanced,
    breakable,
    sharp corners,
    colback=excolor!20,
    boxrule=0pt,
    leftrule=4pt,       
    colframe=excolor,
    left=8pt,
    right=8pt,
  }
}
\newkeytheorem{repitition}[
  Refname={Wiederholung, Wiederholungen},
  style=repstyle, 
  sibling=definition,
  name=Wiederholung,
]

% Application
\definecolor{appcolor}{RGB}{60, 158, 153}
\newkeytheoremstyle{appstyle}
{
headfont=\normalfont\scshape\bfseries,
notefont=\normalfont\bfseries,
notebraces={(}{)},  % chktex 9
headpunct={.},
bodyfont=\normalfont,
headformat=\NAME~\NUMBER\NOTE,
break,
tcolorbox-no-titlebar={
    enhanced,
    breakable,
    sharp corners,
    colback=appcolor!20,
    boxrule=0pt,
    leftrule=4pt,       
    colframe=appcolor,
    left=8pt,
    right=8pt,
  }
}
\newkeytheorem{application}[
  Refname={Anwendung, Anwendungen},
  style=appstyle, 
  sibling=definition,
  name=Anwendung,
]

% Remark 
\newkeytheoremstyle{remstyle}
{
headfont=\normalfont\bfseries\scshape,
notebraces={}{},
headpunct={.},
bodyfont=\normalfont,
headformat=\NAME~\NUMBER\NOTE,
break,
tcolorbox-no-titlebar={
    enhanced,
    breakable,
    sharp corners,
    colback=white,
    boxrule=1pt,  
    leftrule=4pt,    
    colframe=black,
    left=8pt,
    right=8pt,
  }
}
\newkeytheorem{remark}[
  Refname={Bemerkung, Bemerkungen},
  style=remstyle,
  sibling=definition,
  name=Bemerkung,
]

% Example
\newkeytheoremstyle{exstyle}
{
headfont=\normalfont\bfseries\scshape,
notebraces={}{},
headpunct={.},
bodyfont=\normalfont,
headformat=\NAME~\NUMBER\NOTE,
}
\newkeytheorem{example}[
  Refname={Beispiel, Beispiele},
  style=exstyle,  
  sibling=definition,
  name=Beispiel,
]

% Code
\setminted{     
    bgcolor = yellow!15,     
    linenos=true,              
    numbersep=5pt,              
    fontsize=\small,            
    breaklines=true,            
    frame=single,                         
    escapeinside=||, 
    framesep=0pt,
    autogobble=true, 
    style=xcode,             
}

% Output (from code)
\newminted{output}{
    bgcolor = gray!15, 
    linenos=false,                                
    fontsize=\small,            
    breaklines=true,            
    frame=single,                         
    escapeinside=||, 
    framesep=0pt,            
    autogobble=true,
    style=bw,   
}

\newenvironment{longlisting}{\captionsetup{type=listing}}{}

% Less vertical space after code
\AfterEndEnvironment{minted}{\vspace{-4pt}}

% Initiate header
\automark[chapter]{chapter}
\automark*[section]{}

% Header rule and format
\clearpairofpagestyles
\rohead{%
  \headmark\quad
  \makebox[0pt][l]{%
    \makebox[\marginparsep][r]{%
    \raisebox{0pt}[\ht\strutbox][\dp\strutbox]{%
      \rule[-\dp\strutbox]{1pt}{\dimexpr 1in+\topmargin+\headheight+7mm}%
      }%
    \nobreakspace
    }%
    \makebox[\marginparwidth][l]{\footnotesize\pagemark}%
  }%
}
\lehead{%
  \makebox[0pt][r]{%
    \makebox[0pt][r]{\footnotesize\pagemark}%
    \makebox[\marginparsep][l]{%
      \nobreakspace
      \raisebox{0pt}[\ht\strutbox][\dp\strutbox]{%
        \rule[-\dp\strutbox]{1pt}{\dimexpr 1in+\topmargin+\headheight+7mm}%
      }%
    }%
  }%
  \quad\headmark
}

% Header font format
\renewcommand*{\chaptermarkformat}{%
\footnotesize{\bfseries\chapapp~\thechapter}\autodot\enskip}
\renewcommand*{\sectionmarkformat}{%
\footnotesize{\bfseries\thesection}\autodot\enskip}

% Letterspacing chaptermark
\renewcommand*{\chaptermark}[1]{%
  \markboth{%
    \Ifnumbered{chapter}{%
      \MakeMarkcase{\chaptermarkformat}% 
    }{}%
    \MakeMarkcase{\textls{#1}}% 
  }{%
    \Ifnumbered{chapter}{%
      \MakeMarkcase{\chaptermarkformat}% 
    }{}%
    \MakeMarkcase{\textls{#1}}% 
  }%
}

% Letterspacing sectionmark
\renewcommand*{\sectionmark}[1]{%
  \markright{%
    \Ifnumbered{section}{%
      \MakeMarkcase{\sectionmarkformat}% 
    }{}%
    \MakeMarkcase{\textls{#1}}% 
  }%
}

% Pagestyle for frontmatter
\newpairofpagestyles
  [scrheadings]
  {front}
  {
    \ohead*{}
    \ofoot*{\pagemark}
  }

% URL only for documents and websites in bib
\AtEveryBibitem{%
  \ifentrytype{online}{%
  }{%
    \ifentrytype{misc}{%
    }{%
      \clearfield{url}%
      \clearfield{urlyear}%
    }% 
  }%    
}

% Only year in bib
\AtEveryBibitem{\clearfield{month}}
\AtEveryBibitem{\clearfield{day}}

% Caption no colon
\renewcommand*{\captionformat}{\ }

% New caption for figures (only for german)
\renewcaptionname{ngerman}{\figurename}{Abb.}
\renewcommand*{\figureformat}{\bfseries\figurename~\thefigure\autodot}

% New caption for tables (only for german)
\renewcaptionname{ngerman}{\tablename}{Tab.}
\renewcommand*{\tableformat}{\bfseries\tablename~\thetable\autodot}

% New caption for code
\SetupFloatingEnvironment{listing}{name=Code,autorefname=Code}
\captionsetup[listing]{skip=-2pt,labelfont=bf}
\zcRefTypeSetup{listing}{
Name-sg = Code,
Name-pl = Codes,
}

% Layout ToC
\RedeclareSectionCommands[
  toclinefill=\hspace{14pt},
  tocraggedpagenumber,
]{part,chapter,section,subsection,subsubsection,paragraph,subparagraph}

% Letterspacing chapterfont ToC
\newfontfamily\lscharter{XCharter}[LetterSpace=5]
\RedeclareSectionCommand[
  tocentryformat=\lscharter\scshape\bfseries,
]{chapter}

% Layout ToT, ToF
\DeclareTOCStyleEntries[
  linefill=\hspace{14pt}, 
  raggedentrytext=true
]{default}{figure,table}

% Prepare chapter numbers
\definecolor{chaptergrey}{gray}{0.5}
\newfontface\eulerfont{Euler Math}

% Chapter + section font and chapter number font
\addtokomafont{disposition}{\normalfont\scshape\bfseries}
\newkomafont{chapternumber}{\fontsize{60}{70}\normalfont\color{chaptergrey}\eulerfont} 
\addtokomafont{pagehead}{\normalfont\scshape}

% No dot after chapter number if no prefix
\renewcommand*{\chapterformat}{\IfUsePrefixLine{
  \mbox{\chapappifchapterprefix{\nobreakspace}\thechapter
    \autodot}
  }
  {\thechapter}
}

% Chapter title format
\makeatletter
\renewcommand*{\chapterlinesformat}[3]{%
  \Ifstr{#1}{chapter}{%
  \parbox[t]{\linewidth}{\textls{#3}}%
  \makebox[0pt][l]{\hspace{7pt}\usekomafont{chapternumber}{#2}}%
  \par\nobreak\rule[.6\baselineskip]{\linewidth}{1pt}\par\nobreak%
  \vspace{-10pt}
  }{}%
}

% Section title letters spaced
\renewcommand{\sectionlinesformat}[4]{%
\@hangfrom{\hskip #2#3}{\textls{#4}}% chktex 41
}
\makeatother

% Allow page breaks in equations
\allowdisplaybreaks[3]

% Allow page breaks in boxes
\tcbuselibrary{breakable}
\tcbuselibrary{skins}

% Version from pgfplot
\pgfplotsset{compat=1.18}

% Externalization for pgfplots for better compiling time
\usepgfplotslibrary{external}
\tikzset{external/system call={lualatex \tikzexternalcheckshellescape -halt-on-error -interaction=batchmode -jobname "\image" "\texsource"}} % chktex 18
\tikzexternalize

% Otherwise error with tikz-externalize
\tcbset{shield externalize}

% Alternative to flushbottom
% \raggedbottom

